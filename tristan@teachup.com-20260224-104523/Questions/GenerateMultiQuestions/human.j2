{# Historique des questions déjà posées #}
{% set all_questions = other_questions + input_questions %}

{# Historique des bonnes réponses déjà utilisées #}
{% set all_good_answers = all_questions | map(attribute='good_answers') | list %}

{# Construction des requêtes à partir des objectifs pédagogiques #}
{% set ns = namespace(kb_query="", ctx_query="") %}
{% for objective in objectives %}
  {% set ns.kb_query = ns.kb_query ~ objective ~ '; ' %}
  {% set ns.ctx_query = ns.ctx_query ~ objective ~ '; ' %}
{% endfor %}

{% set number_characters = range(5000, 12000) | random %}

{% set kb = knowledge_base | rag(ns.kb_query, 'mmr', number_characters) %}
{% set ctx = context | rag(ns.ctx_query, 'mmr', number_characters) %}

---

CONTENU AUTORISÉ — SOURCE UNIQUE DE VÉRITÉ

{% if deep_rag %}
La base de connaissances d'où tirer les questions est composée de :
"""{{ kb }}"""
et de : 
"""{{ ctx }}""".
{% else %}
La base de connaissances d'où tirer les questions ne doit être QUE : 
"""{{ input_content }}"""
{% endif %}


Il est strictement interdit :
- d’inventer une information,
- d’introduire un concept absent,
- de reformuler une question déjà posée.

---

MÉTHODE OBLIGATOIRE DE GÉNÉRATION (À SUIVRE DANS CET ORDRE)

Pour CHAQUE question :

1. Identifie UNE connaissance clé réellement utile pour atteindre l’objectif pédagogique.
2. Formule cette connaissance sous forme de bonne réponse courte (2 à 8 mots).
3. Vérifie que cette bonne réponse n’a jamais été utilisée :
"""{{ all_good_answers }}"""
4. Construis une question fermée qui appelle EXACTEMENT cette réponse.
5. Construis deux distracteurs :
- plausibles,
- du même registre,
- clairement faux,
- non partiellement justes.

---

CONTRAINTES MAJEURES

- Génère exactement 2 à 4 questions.
- Chaque question doit être totalement différente de :
"""{{ all_questions }}"""
- Chaque bonne réponse doit être nouvelle.
- Aucune réponse ne contient de ponctuation finale.

---

FORMAT DE SORTIE — JSON STRICT

{
"questions": [
{
"title": "...",
"good_answers": ["..."],
"niveau": "compréhension | application | analyse"
}
],
"error": false
}
